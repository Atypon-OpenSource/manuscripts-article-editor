image: registry.gitlab.com/mpapp-private/manuscripts-frontend/node8-aws

# Environment variables needed:
#
# API_BASE_URL: the base URL of the manuscripts-api endpoint
# API_APPLICATION_ID: the application ID sent to the manuscripts-api endpoint
# SYNC_GATEWAY_URL: the base URL of the sync gateway endpoint
# S3_BUCKET: S3 bucket name
# CLOUDFRONT_ID: CloudFront distribution ID
# STORYBOOK_BUCKET_NAME: Storybook S3 bucket name
# STORYBOOK_DISTRIBUTION_ID: Storybook CloudFront distribution ID

before_script:
  - . scripts/export-variables.sh
  - npm config set //atypon-npm-registry.herokuapp.com/:_authToken ${NPM_TOKEN}

stages:
  - test
  - deploy

lint_test_build:
  stage: test
  script:
    - yarn install --frozen-lockfile --non-interactive
    - yarn lint
    - yarn test --coverage
    - yarn build
  tags:
    - nodejs-8
  artifacts:
    paths:
      - ./coverage
    expire_in: 1 week
    when: always
  coverage: /All files[^|]*\|[^|]*\s+([\d\.]+)/


testcafe-chromium:
  stage: test
  script:
    - docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} registry.gitlab.com
    - ./scripts/run-testcafe-tests.sh testcafe_chromium
  after_script:
    - yarn run docker-compose:testcafe down -v
  artifacts:
    paths:
      - ./screenshots
    expire_in: 1 week
    when: on_failure
  tags:
    - docker-compose

testcafe-firefox:
  stage: test
  script:
    - docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} registry.gitlab.com
    - ./scripts/run-testcafe-tests.sh testcafe_firefox
  after_script:
    - yarn run docker-compose:testcafe down -v
  artifacts:
    paths:
      - ./screenshots
    expire_in: 1 week
    when: on_failure
  tags:
    - docker-compose
  only:
    - master
    - triggers

testcafe-firefox-manual:
  stage: test
  script:
    - docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} registry.gitlab.com
    - ./scripts/run-testcafe-tests.sh testcafe_firefox
  after_script:
    - yarn run docker-compose:testcafe down -v
  artifacts:
    paths:
      - ./screenshots
    expire_in: 1 week
    when: on_failure
  when: manual
  tags:
    - docker-compose

testcafe-chromium-manual:
  stage: test
  script:
    - docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} registry.gitlab.com
    - ./scripts/run-testcafe-tests.sh testcafe_chromium
  after_script:
    - yarn run docker-compose:testcafe down -v
  artifacts:
    paths:
      - ./screenshots
    expire_in: 1 week
    when: on_failure
  when: manual
  tags:
    - docker-compose

storybook:
  environment:
    name: storybook
    url: https://storybook.manuscripts.io/
  stage: deploy
  script: scripts/deploy-storybook.sh
  tags:
    - nodejs-8
    - awscli
  only:
    - master
    - triggers

storybook_manual:
  environment:
    name: storybook
    url: https://storybook.manuscripts.io/
  stage: deploy
  script: scripts/deploy-storybook.sh
  tags:
    - nodejs-8
    - awscli
  when: manual

deploy_production:
  environment:
    name: production
    url: https://www.manuscripts.io/
  stage: deploy
  script:
    - scripts/deploy.sh
  tags:
    - nodejs-8
    - awscli
    - sentry-cli
  only:
    - /^v\d+\./ # only deploy release tags, which start with "v" and a version number

deploy_test:
  environment:
    name: test
    url: https://test.manuscripts.io/
  stage: deploy
  script:
    - scripts/deploy.sh
  tags:
    - nodejs-8
    - awscli
    - sentry-cli
  only:
    refs:
      - test

deploy_test_manual:
  environment:
    name: test
    url: https://test.manuscripts.io/
  stage: deploy
  script: scripts/deploy.sh
  tags:
    - nodejs-8
    - awscli
    - sentry-cli
  when: manual

deploy_dev:
  environment:
    name: dev
    url: https://dev.manuscripts.io/
  stage: deploy
  script:
    - scripts/deploy.sh
  tags:
    - nodejs-8
    - awscli
    - sentry-cli
  only:
    - master
    - triggers

deploy_dev_manual:
  environment:
    name: dev
    url: https://dev.manuscripts.io/
  stage: deploy
  script: scripts/deploy.sh
  tags:
    - nodejs-8
    - awscli
    - sentry-cli
  when: manual

