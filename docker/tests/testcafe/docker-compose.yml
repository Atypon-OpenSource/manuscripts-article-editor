version: '3'

services:
  couchbase:
    image: registry.gitlab.com/mpapp-private/manuscripts-api/couchbase
    env_file:
      - env
    ports:
      - 8091:8091
      - 8092:8092
      - 8093:8093
      - 8094:8094
      - 11207:11207
      - 11208:11208
      - 11209:11209
      - 11210:11210
      - 18091:18091
      - 18092:18092
      - 18093:18093
      - 18094:18094
    volumes:
      - couchbase-data:/opt/couchbase/var
    networks:
      default:
        aliases:
          - cb-test.manuscripts.io


  sync_gateway:
    image: registry.gitlab.com/mpapp-private/manuscripts-api/sync_gateway
    env_file:
      - env
    depends_on:
      - couchbase
    ports:
      - 4984:4984
      - 4985:4985
    networks:
      default:
        aliases:
          - sg-test.manuscripts.io

  api:
    image: registry.gitlab.com/mpapp-private/manuscripts-api/app
    env_file:
      - env
    depends_on:
      - couchbase
      - sync_gateway
    ports:
      - 3000:3000
    environment:
      - INITIALIZE_DATABASE
      - NODE_ENV=development
    networks:
      default:
        aliases:
          - api-test.manuscripts.io
  client:
    build:
      context: ../../..
      dockerfile: docker/client/development/Dockerfile
    depends_on:
      - api
      - couchbase
      - sync_gateway
      - data
    env_file:
      - env
    environment:
      - PUBLIC_HOST=client-test.manuscripts.io:8080
    ports:
      - 8080:8080
    volumes:
      - build-cache:/app/node_modules/.cache
    networks:
      default:
        aliases:
          - client-test.manuscripts.io

  testcafe_chromium:
    build:
      context: ../../..
      dockerfile: docker/tests/testcafe/Dockerfile-all-tests
    env_file:
      - env
    environment:
      SCREENSHOTS_VOLUME: '${HOME}/screenshots/chromium'
    command: "'chromium --no-sandbox' /testcafe-tests --screenshots /screenshots/chromium --screenshots-on-fail --page-load-timeout 10000 --speed 0.8"
    depends_on:
      - api
      - client
      - sync_gateway
      - couchbase
      - data
    ports:
      - 1337:1337
      - 1338:1338
      - 9223:9223
      - 9222:9222
    volumes:
      - '${SCREENSHOTS_VOLUME}:/screenshots/chromium'
      - yarn-cache:/cache/yarn
    networks:
      default:
        aliases:
          - testcafe.manuscripts.io

  testcafe_firefox:
    build:
      context: ../../..
      dockerfile: docker/tests/testcafe/Dockerfile-shell
    env_file:
      - env
    environment:
      SCREENSHOTS_VOLUME: '${HOME}/screenshots/firefox'
    command: "'firefox --no-sandbox' /testcafe-tests --screenshots /screenshots/firefox --screenshots-on-fail --page-load-timeout 10000 --speed 0.8"
    depends_on:
      - api
      - client
      - sync_gateway
      - couchbase
      - data
    ports:
      - 1347:1337
      - 1348:1338
      - 9233:9223
      - 9232:9222
    volumes:
      - '${SCREENSHOTS_VOLUME}:/screenshots/firefox'
      - yarn-cache:/cache/yarn
    networks:
      default:
        aliases:
          - testcafe.manuscripts.io

  data:
    image: registry.gitlab.com/mpapp-private/manuscripts-data/manuscripts-data
    ports:
      - 8020:8020
    networks:
      default:
        aliases:
          - data-test.manuscripts.io

volumes:
  couchbase-data:
  screenshots:
  yarn-cache:
    external: true
  build-cache:
    external: true
