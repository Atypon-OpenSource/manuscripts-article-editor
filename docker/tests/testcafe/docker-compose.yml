version: '3'

services:
  couchbase:
    image: registry.gitlab.com/mpapp-private/manuscripts-api/couchbase
    env_file:
      - ../../server/defaults.env
    ports:
      - 8091:8091
      - 8092:8092
      - 8093:8093
      - 8094:8094
      - 11207:11207
      - 11208:11208
      - 11209:11209
      - 11210:11210
      - 18091:18091
      - 18092:18092
      - 18093:18093
      - 18094:18094
    environment:
      - APP_COUCHBASE_HOSTNAME=cb-test.manuscripts.io
    volumes:
      - couchbase-data:/opt/couchbase/var
    networks:
      default:
        aliases:
          - cb-test.manuscripts.io

  sync_gateway:
    image: registry.gitlab.com/mpapp-private/manuscripts-api/sync_gateway
    env_file:
      - ../../server/defaults.env
    depends_on:
      - couchbase
    ports:
      - 4984:4984
      - 4985:4985
    environment:
      - APP_COUCHBASE_HOSTNAME=cb-test.manuscripts.io
      - APP_DB_URI=couchbase://cb-test.manuscripts.io/
      - APP_GATEWAY_ADMIN_PORT=4985
      - APP_GATEWAY_HOSTNAME=sg-test.manuscripts.io
      - APP_GATEWAY_PUBLIC_PORT=4984
      - APP_ALLOWED_CORS_ORIGINS=http://0.0.0.0:8080;http://127.0.0.1:8080;http://client-test.manuscripts.io:8080;http://client-test.manuscripts.io:8081
      - APP_GATEWAY_COOKIE_DOMAIN=.manuscripts.io
    networks:
      default:
        aliases:
          - sg-test.manuscripts.io

  api:
    image: registry.gitlab.com/mpapp-private/manuscripts-api/app
    env_file:
      - ../../server/defaults.env
    depends_on:
      - couchbase
      - sync_gateway
    ports:
      - 3000:3000
    environment:
      - INITIALIZE_DATABASE
      - NODE_ENV=development
      - APP_BASE_URL=http://client-test.manuscripts.io:8080
      - APP_COUCHBASE_HOSTNAME=cb-test.manuscripts.io
      - APP_DB_URI=couchbase://cb-test.manuscripts.io/
      - APP_FROM_EMAIL=no-reply@manuscriptsapp.com
      - APP_GATEWAY_ADMIN_PORT=4985
      - APP_GATEWAY_HOSTNAME=sg-test.manuscripts.io
      - APP_GATEWAY_PUBLIC_PORT=4984
      - APP_GOOGLE_AUTH_CALLBACK=http://api-test.manuscripts.io:3000/api/v1/auth/google/callback
      - APP_ALLOWED_CORS_ORIGINS=http://0.0.0.0:8080;http://127.0.0.1:8080;http://client-test.manuscripts.io:8080;http://client-test.manuscripts.io:8081
      - APP_GATEWAY_COOKIE_DOMAIN=.manuscripts.io

    networks:
      default:
        aliases:
          - api-test.manuscripts.io
  client:
    build:
      context: ../../..
      dockerfile: docker/client/production/Dockerfile
      args:
        API_APPLICATION_ID: io.manuscripts
        API_BASE_URL: http://api-test.manuscripts.io:3000/api/v1
        BASE_URL: http://client-test.manuscripts.io:8080
        DATA_URL: http://data-test.manuscripts.io:8020
        GIT_COMMIT_HASH: $GIT_COMMIT_HASH
        GIT_VERSION: $GIT_VERSION
        NPM_TOKEN: $NPM_TOKEN
        PROJECTS_BUCKET: 'projects'
        SERVICEWORKER_ENABLED: 0
        SYNC_GATEWAY_URL: http://sg-test.manuscripts.io:4984
        WAYF_KEY: $WAYF_KEY
        WAYF_URL: $WAYF_URL
    depends_on:
      - api
      - couchbase
      - sync_gateway
      - data
    ports:
      - 8080:8080
    volumes:
      - yarn-cache:/cache/yarn
      - build-cache:/app/node_modules/.cache
    networks:
      default:
        aliases:
          - client-test.manuscripts.io

  testcafe_chromium:
    build:
      context: ../../..
      dockerfile: docker/tests/testcafe/Dockerfile
    environment:
      - BASE_URL=http://client-test.manuscripts.io:8080
      - API_BASE_URL=http://api-test.manuscripts.io:3000/api/v1
      - DATA_URL=http://data-test.manuscripts.io:8020
      - SYNC_GATEWAY_URL=http://sg-test.manuscripts.io:4984
    command: "'chromium:headless --no-sandbox' '/testcafe-tests/**/*js' --screenshots /screenshots --screenshots-on-fails --page-load-timeout 60000 --selector-timeout 60000 --assertion-timeout 60000 --disable-dev-shm-usage"
    depends_on:
      - api
      - client
      - sync_gateway
      - couchbase
      - data
    ports:
      - 1337:1337
      - 1338:1338
      - 9223:9223
      - 9222:9222
    volumes:
      - yarn-cache:/cache/yarn
    networks:
      default:
        aliases:
          - testcafe.manuscripts.io

  testcafe_firefox:
    build:
      context: ../../..
      dockerfile: docker/tests/testcafe/Dockerfile
    environment:
      - BASE_URL=http://client-test.manuscripts.io:8080
      - API_BASE_URL=http://api-test.manuscripts.io:3000/api/v1
      - DATA_URL=http://data-test.manuscripts.io:8020
      - SYNC_GATEWAY_URL=http://sg-test.manuscripts.io:4984
    command: "'firefox:headless --no-sandbox' '/testcafe-tests/**/*js' --screenshots /screenshots --screenshots-on-fails --page-load-timeout 60000 --selector-timeout 60000 --assertion-timeout 60000 --shm-size=1gb"
    depends_on:
      - api
      - client
      - sync_gateway
      - couchbase
      - data
    ports:
      - 1347:1337
      - 1348:1338
      - 9233:9223
      - 9232:9222
    volumes:
      - yarn-cache:/cache/yarn
    networks:
      default:
        aliases:
          - testcafe.manuscripts.io

  data:
    image: registry.gitlab.com/mpapp-private/manuscripts-data/manuscripts-data
    ports:
      - 8020:8020
    networks:
      default:
        aliases:
          - data-test.manuscripts.io

volumes:
  couchbase-data:
  yarn-cache:
    external: true
  build-cache:
    external: true
